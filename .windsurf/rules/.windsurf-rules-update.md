---
trigger: always_on
---

# Pharmacy Scraper Cascade Rules Configuration
# Version: 2.0.0
# Last Updated: 2025-08-10

# Rule Set for Pharmacy Scraper Project
rules:
  # Template Assistance Rules
  - name: template-assistance
    description: Provide template-based assistance for common tasks
    triggers:
      - intent: create_issue
        patterns: 
          - "create (bug|issue|ticket)"
          - "report a problem"
          - "found an? (issue|bug)"
        priority: high
      - intent: new_feature
        patterns:
          - "add feature"
          - "implement new"
          - "create new (feature|functionality)"
        priority: high
      - intent: update_docs
        patterns:
          - "update documentation"
          - "document this"
          - "add docs"
        priority: medium
    actions:
      - name: suggest_template
        template: "${intent}_template.md"
        description: "Suggested template for ${intent}"
      - name: provide_guidance
        message: |
          Consider including:
          - Clear description of the ${intent}
          - Steps to reproduce (for bugs)
          - Expected vs actual behavior
          - Relevant code snippets
          - Test cases
          - Documentation updates

  # Code Quality Rules
  - name: code-quality-checks
    description: Enforce code quality standards
    triggers:
      - file_change: "*.py"
        actions: [create, modify]
    actions:
      - name: run_linter
        command: "flake8 ${file}"
        on_failure: "warn"
      - name: check_type_hints
        enabled: true
        message: "Consider adding type hints to function signatures"
      - name: suggest_docstrings
        enabled: true
        patterns: 
          - "def "
        message: "Remember to add/update docstrings for functions and classes"

  # Python 3.13+ Compatibility Rules (NEW)
  - name: python-compatibility
    description: Ensure Python 3.13+ compatibility
    triggers:
      - pattern: "retry_if_exception_type.*\\|.*retry_if_exception_type"
        in: [code_change]
    actions:
      - name: warn_tenacity_syntax
        message: "âš ï¸ Tenacity decorator syntax: Use retry_if_exception_type((Exception1, Exception2)) instead of | operator"
        level: "error"
      - name: suggest_fix
        message: "Replace 'retry_if_exception_type(A) | retry_if_exception_type(B)' with 'retry_if_exception_type((A, B))'"

  # Error Handling & Resilience Rules (NEW)
  - name: error-handling
    description: Promote resilient error handling patterns
    triggers:
      - pattern: "except.*:"
        in: [code_change]
    actions:
      - name: check_error_fields
        message: "Consider storing errors in *_error fields instead of failing hard"
      - name: suggest_logging
        message: "Add appropriate logging for error cases"
      - name: check_graceful_degradation
        message: "Ensure graceful degradation when external services fail"

  # Documentation Rules
  - name: documentation-updater
    description: Keep documentation in sync with code changes
    triggers:
      - code_change: "*.py"
        patterns:
          - "def "
          - "class "
    actions:
      - name: check_docs
        message: "Check if documentation needs updating for this change"
      - name: suggest_updates
        template: "documentation_update.md"
        when: "major_change"

  # Test Coverage Rules (ENHANCED)
  - name: test-coverage
    description: Ensure adequate test coverage
    triggers:
      - file_change: "src/**/*.py"
        exclude: ["**/__init__.py", "**/tests/**"]
    actions:
      - name: check_test_file
        pattern: "${file/%.py/_test.py}"
        message: "Consider adding/updating tests for this file"
      - name: suggest_test_cases
        when: "new_function"
        message: "Add test cases for the new function"
      - name: integration_test_reminder
        when: "workflow_change"
        message: "Consider adding integration tests for end-to-end workflow changes"

  # Integration Testing Rules (NEW)
  - name: integration-testing
    description: Ensure comprehensive integration test coverage
    triggers:
      - file_change: "src/**/classifier.py"
      - file_change: "src/**/orchestrator.py"
      - file_change: "src/**/perplexity_client.py"
    actions:
      - name: suggest_integration_tests
        message: "Consider updating integration tests in tests/integration/ for workflow changes"
      - name: check_end_to_end
        message: "Verify end-to-end scenarios: rule-based â†’ LLM â†’ cache decision tree"

  # Project-Specific Rules (ENHANCED)
  - name: pharmacy-scraper-specific
    description: Rules specific to Pharmacy Scraper project
    rules:
      - name: api-key-safety
        description: Prevent accidental API key exposure
        triggers:
          - pattern: "(?:api[_-]?key|token|secret|APIFY_TOKEN|PERPLEXITY_API_KEY)"
            in: [file_content, commit_message]
        actions:
          - name: warn
            message: "ðŸš¨ Potential API key detected. Never commit sensitive information!"
            level: "error"

      - name: classification-accuracy
        description: Monitor classification accuracy
        triggers:
          - pattern: "classify_pharmacy"
            in: [code_change]
        actions:
          - name: suggest_test_cases
            message: "Add test cases for new classification rules"
          - name: check_metrics
            message: "Verify classification metrics after changes"

      - name: cache-management (NEW)
        description: Ensure proper cache handling
        triggers:
          - pattern: "cache"
            in: [code_change]
        actions:
          - name: check_cache_key
            message: "Ensure cache keys are consistent and deterministic"
          - name: verify_cache_invalidation
            message: "Consider cache invalidation strategies for data changes"

  # Commit Quality Rules (NEW)
  - name: commit-standards
    description: Ensure high-quality commit messages
    triggers:
      - commit_message: ".*"
    actions:
      - name: check_conventional_commits
        message: "Use conventional commit format: feat/fix/docs/test/chore: description"
      - name: suggest_detail
        message: "Include what changed and why in commit body"
      - name: check_scope
        message: "Consider adding scope for clarity: feat(classifier): description"

# Rule Priorities
priorities:
  - name: high
    color: "#FF6B6B"
    description: "Critical issues that need immediate attention"
  - name: medium
    color: "#FFD166"
    description: "Important but not critical"
  - name: low
    color: "#06D6A0"
    description: "Nice to have improvements"

# Template Locations
templates:
  feature_request: ".github/ISSUE_TEMPLATE/feature_request.md"
  bug_report: ".github/ISSUE_TEMPLATE/bug_report.md"
  documentation_update: ".github/ISSUE_TEMPLATE/documentation_update.md"

# Ignore Patterns (UPDATED)
ignore:
  - "**/__pycache__/**"
  - "**/.pytest_cache/**"
  - "**/venv/**"
  - "**/node_modules/**"
  - "**/.git/**"
  - "**/*.min.js"
  - "**/*.min.css"
  - "**/cache/**"        # Added cache directory
  - "**/*fix_*.py"       # Ignore scratch/fix scripts
  - "**/*.backup"        # Ignore backup files

# Version Control (UPDATED)
version_control:
  branch_protection:
    main:
      required_reviews: 1
      require_passing_tests: true
      require_linear_history: true
    develop:
      required_reviews: 1
      require_passing_tests: true
  conventional_commits: true    # NEW: Enforce conventional commit format

# Auto-Formatting
formatting:
  python:
    formatter: "black"
    line_length: 88
  markdown:
    formatter: "prettier"
    options: "--prose-wrap always"

# Linting (ENHANCED)
linting:
  python:
    linter: "flake8"
    config: ".flake8"
    compatibility_check: "python3.13"  # NEW: Ensure Python 3.13 compatibility
  markdown:
    linter: "markdownlint"
    config: ".markdownlint.json"

# Testing (ENHANCED)
testing:
  framework: "pytest"
  pattern: "**/*_test.py"
  coverage:
    minimum: 67        # Updated based on current coverage
    target: 80         # Goal to work towards
    report: "term-missing"
  integration_tests:   # NEW: Integration test configuration
    directory: "tests/integration/"
    required_for: ["classifier", "orchestrator", "workflow"]

# Error Recovery Workflows (NEW)
error_recovery:
  test_failures:
    - "Check for import errors first"
    - "Verify dependencies are installed"
    - "Check Python version compatibility"
    - "Review test fixtures and mocking"
  
  compatibility_issues:
    - "Check tenacity decorator syntax for Python 3.13+"
    - "Verify typing imports are compatible"
    - "Test with current Python version"

# Documentation (ENHANCED)
documentation:
  generate:
    enabled: true
    output: "docs/api"
    style: "google"  # Google-style docstrings
  live_preview: true
  integration_examples: true   # NEW: Require integration examples

# Notifications
notifications:
  on_failure: "error"  # or 'warn', 'info', 'none'
  on_success: "info"
  channels:
    - "ide"
    - "cli"
    - "github"

# Memory Management
memory:
  context_window: 8000  # tokens
  max_items: 10
  priority: ["recent", "frequent"]

# Tool Configuration (ENHANCED)
tools:
  code_search:
    max_results: 5
    include: ["src/**/*.py", "tests/**/*.py"]
    exclude: ["**/__pycache__/**", "**/cache/**"]
  file_operations:
    confirm_overwrite: true
    create_backup: true
  integration_testing:     # NEW: Integration testing tools
    workflow_validation: true
    end_to_end_coverage: true

# Environment Variables (UPDATED)
environment:
  required:
    - "PYTHONPATH"
  optional:
    - "APIFY_TOKEN"
    - "GOOGLE_PLACES_API_KEY"
    - "PERPLEXITY_API_KEY"
  testing:               # NEW: Test environment variables
    - "PYTEST_CURRENT_TEST"

# Security (ENHANCED)
security:
  secrets_detection: true
  banned_patterns:
    - "(?:password|secret|api[_-]?key|token)\\s*[=:]"
    - "APIFY_TOKEN\\s*="        # NEW: Specific API token patterns
    - "PERPLEXITY_API_KEY\\s*="
  allowed_domains:
    - "api.apify.com"
    - "maps.googleapis.com"
    - "api.perplexity.ai"

# Workflow Automation (NEW)
workflows:
  pre_commit:
    - "run_tests"
    - "check_lint"
    - "validate_commit_message"
  
  post_merge:
    - "update_documentation"
    - "run_integration_tests"
    
  dependency_update:
    - "test_compatibility"
    - "update_lock_files"
    - "run_full_test_suite"

# Project Evolution (NEW)
evolution:
  domain_agnostic_goal: true   # Working towards generic business data scraper
  plugin_architecture: "planned"
  configuration_driven: "in_progress"
  
  success_metrics:
    - "test_coverage > 80%"
    - "integration_tests_passing"
    - "zero_hard_coded_secrets"
    - "python_3_13_compatible"
