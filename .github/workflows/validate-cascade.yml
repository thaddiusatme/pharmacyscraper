name: Validate Cascade Rules

on:
  push:
    paths:
      - '.cascade/**'
      - '.windsurf/rules/**'
  pull_request:
    paths:
      - '.cascade/**'
      - '.windsurf/rules/**'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Cascade Rules
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install PyYAML
      run: pip install pyyaml
    
    - name: Validate YAML syntax for Cascade rules
      run: |
        python -c '
        import yaml, os, sys
        def validate_yaml(file_path):
            try:
                with open(file_path, "r") as f:
                    yaml.safe_load(f)
                print(f"✓ {file_path} is valid YAML")
                return True
            except yaml.YAMLError as e:
                print(f"✗ {file_path} has YAML syntax errors:")
                print(e)
                return False
        
        # Check all YAML files in .cascade and .windsurf/rules
        valid = True
        for root, _, files in os.walk("."):
            if ".cascade" in root or ".windsurf/rules" in root:
                for file in files:
                    if file.endswith(('.yaml', '.yml')):
                        if not validate_yaml(os.path.join(root, file)):
                            valid = False
        
        if not valid:
            sys.exit(1)
        '
    
    - name: Check for required fields in Cascade rules
      run: |
        python -c '
        import yaml, os, sys
        
        def check_required_fields(rules, required_fields, file_path):
            missing = []
            for field in required_fields:
                if field not in rules:
                    missing.append(field)
            if missing:
                print(f"✗ {file_path} is missing required fields: {', '.join(missing)}")
                return False
            return True
        
        required_fields = ["rules", "version"]
        valid = True
        
        # Check .cascade/rules
        for root, _, files in os.walk(".cascade"):
            for file in files:
                if file.endswith(('.yaml', '.yml')):
                    file_path = os.path.join(root, file)
                    try:
                        with open(file_path, "r") as f:
                            rules = yaml.safe_load(f)
                            if not check_required_fields(rules, required_fields, file_path):
                                valid = False
                    except Exception as e:
                        print(f"Error checking {file_path}: {e}")
                        valid = False
        
        # Check .windsurf/rules
        for root, _, files in os.walk(".windsurf/rules"):
            for file in files:
                if file.endswith(('.yaml', '.yml', '.md')):
                    file_path = os.path.join(root, file)
                    try:
                        with open(file_path, "r") as f:
                            # Skip YAML front matter in markdown files
                            content = f.read()
                            if file.endswith('.md'):
                                if '---\n' in content:
                                    content = content.split('---\n', 2)[1]
                            rules = yaml.safe_load(content)
                            if not check_required_fields(rules, required_fields, file_path):
                                valid = False
                    except Exception as e:
                        print(f"Error checking {file_path}: {e}")
                        valid = False
        
        if not valid:
            sys.exit(1)
        else:
            print("✓ All rule files have the required fields")
        '
    
    - name: Lint with yamllint
      uses: actionshub/yamllint@v1
      with:
        config_file: .github/linters/yamllint.yml
        file_or_dir: .cascade/ .windsurf/rules/
        strict: true
