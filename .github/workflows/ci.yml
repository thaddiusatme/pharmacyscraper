name: CI Pipeline

on:
  push:
    # Run on all branches when pushing to src/, tests/, or .github/workflows/
    paths:
      - 'src/**'
      - 'tests/**'
      - '.github/workflows/**'
    # Run on pushes to main and feature branches
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches: [main, 'feature/**']
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running workflow'
        required: false
        default: 'Manual trigger'
        type: string

env:
  PYTHON_VERSION: '3.10'
  POETRY_VERSION: '1.5.1'

# Set default permissions for the workflow
permissions:
  contents: read
  security-events: write
  actions: read
  checks: write
  statuses: write
  pull-requests: write

jobs:
  test:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10']
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    - name: Install dependencies
      run: |
        poetry install --with dev --no-interaction --no-ansi
    - name: Create test results directory
      run: mkdir -p test-results/${{ matrix.python-version }}
    - name: Run tests with coverage
      run: |
        set -e
        poetry run pytest --cov=src --cov-report=xml --junitxml=test-results/${{ matrix.python-version }}/results.xml || echo "Tests failed, continuing..."
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: test-results/${{ matrix.python-version }}/
    - name: Upload coverage report
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: coverage.xml
        fail_ci_if_error: false
        verbose: true

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy
    - name: Run Black
      run: black --check src tests
    - name: Run Flake8
      run: flake8 src tests
    - name: Run Mypy
      run: mypy --install-types --non-interactive src

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install Bandit
      run: pip install bandit
    - name: Run Bandit security scan
      continue-on-error: true
      run: |
        # Create output directory if it doesn't exist
        mkdir -p bandit-results
        # Run Bandit and save results in SARIF format
        pip install bandit bandit-sarif-formatter
        bandit -r src -f sarif -o bandit-results/bandit-results.sarif || echo "Bandit scan failed, continuing..."
        # Create empty file if no results
        touch bandit-results/bandit-results.sarif
    - name: Upload security scan results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: bandit-results/bandit-results.sarif
      continue-on-error: true

  dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Check for outdated dependencies
      id: outdated
      run: |
        pip install pip-tools
        pip list --outdated --format=json > outdated.json
        echo "has_outdated=$(jq -r 'if length > 0 then "true" else "false" end' outdated.json)" >> $GITHUB_OUTPUT
    - name: Create issue for outdated dependencies
      uses: peter-evans/create-issue-from-file@v5
      if: steps.outdated.outputs.has_outdated == 'true'
      with:
        title: 'Dependency Updates Available'
        content-filepath: ./outdated.json
        assignees: ${{ github.actor }}
        labels: dependencies,automated

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install documentation dependencies
      run: |
        pip install -r docs/requirements.txt
    - name: Build documentation
      run: |
        mkdir -p docs/_build/html
        cd docs && make html || echo "Documentation build failed, continuing..."
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/_build/html/

  notify:
    name: Notify Status
    if: always()
    needs: [test, lint, security, dependencies, docs]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Check if all jobs passed
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: exit 1
      
      # Only run Slack notifications if the secret is configured
      - name: Check for Slack webhook
        id: check-slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "slack_configured=true" >> $GITHUB_OUTPUT
          else
            echo "Slack webhook not configured, skipping notifications"
            echo "slack_configured=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Slack notification
        if: steps.check-slack.outputs.slack_configured == 'true'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: ${{ job.status == 'success' && '#36a64f' || '#ff0000' }}
          SLACK_TITLE: 'Workflow ${{ job.status }}: ${{ github.workflow }} #${{ github.run_number }}'
          SLACK_MESSAGE: |
            Commit: ${{ github.sha }} on ${{ github.ref_name }} by @${{ github.actor }}
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
